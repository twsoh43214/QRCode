<script>
function qrUrl(data){
  const size = 800;
  const margin = 12;
  const ecc = "Q";
  return (
    "https://api.qrserver.com/v1/create-qr-code/?" +
    "format=png" +
    "&size=" + size + "x" + size +
    "&margin=" + margin +
    "&ecc=" + ecc +
    "&data=" + encodeURIComponent(data)
  );
}

function normalize(str){
  return str.replace(/\u00A0/g," ").trim();
}

/**
 * Expand a range like "RTF-1:RTF-30" into ["RTF-1", ..., "RTF-30"].
 * Rules:
 * - Both sides must share the same prefix (everything except the final number)
 * - Expands inclusive
 * - Preserves zero padding width from the start token (e.g. 001)
 */
function expandRange(line){
  // Must contain exactly one ":" separating start and end
  const parts = line.split(":").map(s => normalize(s));
  if(parts.length !== 2) return null;

  const [a, b] = parts;
  if(!a || !b) return null;

  // Match "prefix + trailing digits" (e.g., "RTF-" + "001")
  const re = /^(.*?)(\d+)$/;
  const ma = a.match(re);
  const mb = b.match(re);
  if(!ma || !mb) return null;

  const prefixA = ma[1];
  const prefixB = mb[1];
  if(prefixA !== prefixB) return null; // different prefixes, don't expand

  const startNumStr = ma[2];
  const endNumStr   = mb[2];
  const start = parseInt(startNumStr, 10);
  const end   = parseInt(endNumStr, 10);
  if(Number.isNaN(start) || Number.isNaN(end)) return null;

  const width = startNumStr.length; // keep padding from start side
  const step = start <= end ? 1 : -1;

  const out = [];
  for(let n = start; step > 0 ? n <= end : n >= end; n += step){
    const num = String(n).padStart(width, "0");
    out.push(prefixA + num);
  }
  return out;
}

function generateBulk(){
  const input = document.getElementById("bulkInput").value;

  const rawLines = input.split("\n")
    .map(l => normalize(l))
    .filter(l => l.length > 0);

  // Expand ranges
  const codes = [];
  for(const line of rawLines){
    const expanded = line.includes(":") ? expandRange(line) : null;
    if(expanded && expanded.length){
      codes.push(...expanded);
    }else{
      codes.push(line);
    }
  }

  const preview = document.getElementById("preview");
  preview.innerHTML = "";

  codes.forEach(code => {
    const label = document.createElement("div");
    label.className = "label";

    const qr = document.createElement("div");
    qr.className = "qr";

    const img = document.createElement("img");
    img.src = qrUrl(code);
    img.alt = "QR";
    qr.appendChild(img);

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = code;

    label.appendChild(qr);
    label.appendChild(text);
    preview.appendChild(label);
  });
}

function clearLabels(){
  document.getElementById("preview").innerHTML = "";
  document.getElementById("bulkInput").value = "";
}
</script>
